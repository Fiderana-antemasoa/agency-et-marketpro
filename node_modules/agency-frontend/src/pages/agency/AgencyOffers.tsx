import { useState, useEffect } from "react";
import { useParams } from "react-router-dom"; 
import { AgencyLayout } from "@/components/agency/AgencyLayout";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle, DialogTrigger } from "@/components/ui/dialog";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { ImageUpload } from "@/components/ui/image-upload";
import { MultipleImageUpload } from "@/components/ui/multiple-image-upload";
import { Search, Plus, Filter, ShoppingCart, Clock, CheckCircle, Edit, ChevronsUpDown ,X } from "lucide-react";
import { useToast } from "@/hooks/use-toast";
// Ligne 15 (aprÃ¨s les imports existants)
import { useTranslation } from "react-i18next";
import { useAuth } from "@/context/AuthContext";
import { Link, useNavigate } from "react-router-dom";
import { invalidateTagsCache, getPopularTagsFromOffers } from "@/services/tagsService";
import { Offer } from "@/types/offers";

// âœ… Type pour une offre
// type Offer = {
//   id: number;
//   title: string;
//   description: string;
//   price: string;
//   currency?: string;
//   category: string;
//   validUntil?: string;
//   delivery_date?: string;
//   avatar?: string;
//   images?: string[]; // Nouvelles images multiples
//   seller_profile?: string;
//   condition_state?: "new" | "like_new" | "good" | "fair" | "poor" | "to_repair";
//   tags?: string[];
//   reviews?: Array<{
//     rating: number;
//     comment: string;
//     user_name?: string;
//   }>;
//   status: "active" | "pending" | "unknown";
//   localisation: string;
//   clientsCount: number;
//   created_at?: string; // âœ… Ajout pour le filtrage par nouveautÃ©
//   updated_at?: string;
// };

// âœ… Fonction pour obtenir le badge de statut
const getStatusBadge = (status: Offer["status"], t: any) => {
  switch (status) {
    case "active":
      return (
        <Badge className="bg-success/10 text-success border-success/20">
          <CheckCircle className="w-3 h-3 mr-1" />{t("active")}
        </Badge>
      );
    case "pending":
      return (
        <Badge variant="secondary">
          <Clock className="w-3 h-3 mr-1" />{t("common.pending")}
        </Badge>
      );
    default:
      return <Badge variant="outline">{t("common.unknown")}</Badge>;
  }
};

//composant!!!
export default function AgencyOffers() {
  //ajout pour la traduction
  const { t } = useTranslation(["offers", "common"]);
  const { toast } = useToast();
  const { id } = useParams();
  const { hasPermission, isAdmin, getIsLoading } = useAuth();
  const navigate = useNavigate();

  // âœ… State typÃ©s
  const [offers, setOffers] = useState<Offer[]>([]);
  const [isDialogOpen, setIsDialogOpen] = useState(false);
  const [newOffer, setNewOffer] = useState<Omit<Offer, "id" | "status" | "clientsCount">>({
    title: "",
    description: "",
    price: 0,
    currency: "EUR",
    category: "",
    validUntil: "",
    delivery_date: "",
    localisation: "",
    avatar: "",
    images: [], // Nouveau champ pour images multiples
    condition_state: "new",
    tags: [],
    reviews: [],
    created_at: undefined,
    updated_at: undefined,
  });

  const [offerToDelete, setOfferToDelete] = useState<Offer | null>(null);
  const [isCustomCategory, setIsCustomCategory] = useState(false);
  const [customCategory, setCustomCategory] = useState("");
  
  // State pour les suggestions de tags dynamiques
  const [suggestedTags, setSuggestedTags] = useState<string[]>([
    'design', 'ui', 'ux', 'moderne', 'responsive', 'web', 'seo', 'marketing', 'consulting'
  ]);
  
  // State pour l'input de nouveau tag
  const [newTagInput, setNewTagInput] = useState('');

  // Mapping des catÃ©gories pour l'affichage
  const getCategoryLabel = (value: string) => {
    const categoryMap: Record<string, string> = {
      web: "ğŸŒ DÃ©veloppement Web",
      seo: "ğŸ” SEO & RÃ©fÃ©rencement", 
      marketing: "ğŸ“ˆ Marketing Digital",
      design: "ğŸ¨ Design & Graphisme",
      consulting: "ğŸ’¡ Consulting & Conseil",
      courses: "ğŸ“ Formations & Cours",
      software: "âš¡ Logiciels & Outils",
      digital_products: "ğŸ’» Produits NumÃ©riques",
      services: "ğŸ› ï¸ Services Divers",
      electronics: "ğŸ“± Ã‰lectronique",
      fashion: "ğŸ‘— Mode & Style",
      home: "ğŸ  Maison & Jardin",
      automotive: "ğŸš— Automobile",
      sports: "âš½ Sports & Loisirs",
      health: "ğŸ’Š SantÃ© & Bien-Ãªtre",
      books: "ğŸ“š Livres & Ã‰ducation",
      arts: "ğŸ­ Arts & Culture",
      business: "ğŸ’¼ Business & Finance",
      travel: "âœˆï¸ Voyage & Tourisme",
      food: "ğŸ½ï¸ Alimentation"
    };
    return categoryMap[value] || value;
  };

  const API_URL = "http://127.0.0.1:8000/api/offers";

  // Recherche
  const [searchTerm, setSearchTerm] = useState("");
  
  // Filtrage par catÃ©gorie
  const [selectedCategory, setSelectedCategory] = useState<string>("all");
  
  // Filtrage par statut
  const [selectedStatus, setSelectedStatus] = useState<string>("all");

  // Ã‰dition
  const [editingOffer, setEditingOffer] = useState<Offer | null>(null);
  // âœ… AJOUTE CES STATES POUR LA VENTE
  
  const [sellingOffer, setSellingOffer] = useState<Offer | null>(null);
  const [clients, setClients] = useState<any[]>([]);
  const [searchClient, setSearchClient] = useState("");
  const [selectedClient, setSelectedClient] = useState<number | null>(null);
  const filteredClients = clients.filter(client =>
  client.name.toLowerCase().includes(searchClient.toLowerCase()) ||
  client.company.toLowerCase().includes(searchClient.toLowerCase())
  );
  
  useEffect(() => {
    fetch(API_URL)
      .then(res => res.json())
      .then((data: Offer[]) => setOffers(data))
      .catch(err => console.error("Erreur API", err));
  }, []);

  //ajout useEffect 
  // Ajoute APRÃˆS tes autres useEffects
  useEffect(() => {
    if (sellingOffer) {
      fetch("http://127.0.0.1:8000/api/clients")
        .then(res => res.json())
        .then(data => setClients(data))
        .catch(err => console.error("Erreur chargement clients", err));
    }
  }, [sellingOffer]);

  // Mettre Ã  jour les suggestions de tags quand les offres changent
  useEffect(() => {
    if (offers.length > 0) {
      const popularTags = getPopularTagsFromOffers(offers, 12);
      if (popularTags.length > 0) {
        setSuggestedTags(popularTags);
      }
    }
  }, [offers]);

  // Debug: surveiller les changements de tags
  useEffect(() => {
    console.log('ğŸ”„ State newOffer.tags mis Ã  jour:', newOffer.tags);
  }, [newOffer.tags]);

  // Fonction pour ajouter un tag
  const addTag = (tagToAdd: string) => {
    const newTag = tagToAdd.trim().toLowerCase();
    const currentTagsCount = newOffer.tags?.length || 0;
    
    console.log('=== FONCTION AJOUT TAG ===');
    console.log('Tag Ã  ajouter:', `"${newTag}"`);
    console.log('Tags actuels:', newOffer.tags);
    console.log('Nombre de tags:', currentTagsCount);
    
    if (newTag && !newOffer.tags?.includes(newTag) && currentTagsCount < 10) {
      console.log('âœ… AJOUT DU TAG:', newTag);
      const updatedTags = [...(newOffer.tags || []), newTag];
      console.log('Nouveaux tags:', updatedTags);
      setNewOffer((prev) => ({ 
        ...prev, 
        tags: updatedTags
      }));
      setNewTagInput(''); // Vider l'input
      return true;
    } else {
      console.log('âŒ TAG NON AJOUTÃ‰');
      if (!newTag) console.log('Raison: Tag vide');
      if (newOffer.tags?.includes(newTag)) console.log('Raison: Tag existe dÃ©jÃ ');
      if (currentTagsCount >= 10) console.log('Raison: Limite atteinte');
      return false;
    }
  };

  // Liste filtrÃ©e par recherche, catÃ©gorie et statut
  const filteredOffers = offers
    .filter(offer =>
      offer.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      offer.description.toLowerCase().includes(searchTerm.toLowerCase())
    )
    .filter(offer => 
      selectedCategory === "all" || offer.category === selectedCategory
    )
    .filter(offer => 
      selectedStatus === "all" || offer.status === selectedStatus
    )
    .filter(offer => !id || offer.id.toString() === id);

  // âœ… Calculs dynamiques pour les statistiques
  const activeOffersCount = offers.filter(o => o.status === "active").length;
  const totalSales = offers.reduce((sum, o) => sum + o.clientsCount, 0);
  const totalRevenue = offers.reduce((sum, o) => {
    const price = parseFloat(String(o.price).replace(/[^0-9.-]+/g, ""));
    return sum + (price * o.clientsCount);
  }, 0);

  const handleEditOffer = (offer: Offer) => {
    setEditingOffer(offer);
    
    // VÃ©rifier si c'est une catÃ©gorie personnalisÃ©e (pas dans la liste prÃ©dÃ©finie)
    const predefinedCategories = [
      "web", "seo", "marketing", "design", "consulting",
      "courses", "software", "digital_products", "services", 
      "electronics", "fashion", "home", "automotive", "sports", 
      "health", "books", "arts", "business", "travel", "food"
    ];
    const isCustom = !predefinedCategories.includes(offer.category);
    
    setIsCustomCategory(isCustom);
    setCustomCategory(isCustom ? offer.category : "");
    
    setNewOffer({
      title: offer.title,
      description: offer.description,
      price: offer.price !== undefined && offer.price !== null ? Math.max(0, offer.price) : 0,
      currency: offer.currency || "EUR",
      category: offer.category,
      validUntil: offer.validUntil || "",
      delivery_date: offer.delivery_date || "",
      localisation: offer.localisation || "",
      avatar: offer.avatar || "",
      images: offer.images || [], // Charger les images existantes
      condition_state: offer.condition_state || "new",
      tags: offer.tags || [],
      reviews: offer.reviews || [],
      created_at: offer.created_at,
      updated_at: offer.updated_at,
    });
    setIsDialogOpen(true);
  };

  const handleSellOffer = (offerId: number, title: string) => {
    // Trouver l'offre Ã  vendre
    const offer = offers.find(o => o.id === offerId);
    if (!offer) return;

    // RequÃªte PATCH/PUT vers l'API pour incrÃ©menter clientsCount
    fetch(`${API_URL}/${offerId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...offer,
        clientsCount: offer.clientsCount + 1
      })
    })
      .then(res => res.json())
      .then((updatedOffer: Offer) => {
        setOffers(prev => prev.map(o => o.id === offerId ? updatedOffer : o));
        toast({
          title: "Vente enregistrÃ©e",
          description: `Un client ajoutÃ© Ã  "${updatedOffer.title}".`,
        });
      })
      .catch(err => {
        toast({
          title: "Erreur",
          description: "Impossible d'enregistrer la vente.",
          variant: "destructive"
        });
        console.error(err);
      });
  };

  //suppression
  const handleDeleteOffer = (offerId: number, offerTitle: string) => {
    const confirmed = window.confirm(`Voulez-vous vraiment supprimer l'offre "${offerTitle}" ?`);
    if (!confirmed) return;

    fetch(`${API_URL}/${offerId}`, { method: "DELETE" })
      .then(() => {
        setOffers(prev => prev.filter(o => o.id !== offerId));
        toast({ title: "Offre supprimÃ©e", description: `L'offre "${offerTitle}" a Ã©tÃ© retirÃ©e.` });
        try {
          localStorage.setItem('marketplace_products_version', Date.now().toString());
        } catch (e) {
          console.error('Error signaling marketplace update:', e);
        }
      })
      .catch(err => {
        toast({ title: "Erreur", description: "Impossible de supprimer l'offre.", variant: "destructive" });
        console.error(err);
      });

  };

  const handleCreateOrUpdateOffer = () => {
      console.log("ğŸ” DonnÃ©es envoyÃ©es:", {
      localisation: newOffer.localisation,
      fullData: newOffer
    });
    if (!newOffer.title || !newOffer.price || !newOffer.category || !newOffer.localisation) {
    toast({
      title: "Champs manquants",
      description: "Veuillez remplir tous les champs obligatoires (titre, prix, catÃ©gorie, disponibilitÃ©).",
      variant: "destructive",
    });
    return;
  }

    const method = editingOffer ? "PUT" : "POST";
    const url = editingOffer ? `${API_URL}/${editingOffer.id}` : API_URL;

    const currentDate = new Date().toISOString();
    
    fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        ...newOffer,
        localisation: newOffer.localisation || "",
        status: editingOffer ? editingOffer.status : "active",
        clientsCount: editingOffer ? editingOffer.clientsCount : 0,
        created_at: editingOffer ? editingOffer.created_at : currentDate,
        updated_at: currentDate
      }),
    })
      .then(res => res.json())
      .then((savedOffer: Offer) => {
        if (editingOffer) {
          setOffers(prev => prev.map(o => o.id === savedOffer.id ? savedOffer : o));
          toast({ title: "Offre modifiÃ©e", description: `"${savedOffer.title}" a Ã©tÃ© mise Ã  jour.` });
        } else {
          setOffers(prev => [...prev, savedOffer]);
          toast({ title: "Offre crÃ©Ã©e", description: `"${savedOffer.title}" a Ã©tÃ© ajoutÃ©e avec succÃ¨s.` });
        }
        try {
          localStorage.setItem('marketplace_products_version', Date.now().toString());
        } catch (e) {
          console.error('Error signaling marketplace update:', e);
        }
        setNewOffer({ 
          title: "", 
          description: "", 
          price: 0, 
          currency: "EUR",
          category: "", 
          validUntil: "",
          delivery_date: "",
          localisation: "",
          avatar: "",
          images: [], // Reset des images
          condition_state: "new",
          tags: [],
          reviews: [],
          created_at: undefined,
          updated_at: undefined,
        });
        setEditingOffer(null);
        setIsCustomCategory(false);
        setCustomCategory("");
        setIsDialogOpen(false);
        
        // Invalider le cache des tags pour synchroniser avec marketplace
        invalidateTagsCache();
      })
      .catch(err => {
        console.error("Erreur API", err);
        toast({ title: "Erreur", description: "Impossible de sauvegarder l'offre.", variant: "destructive" });
      });
  };

  return (
  <>
    <AgencyLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold text-foreground">{t("title")}</h1>
            <p className="text-muted-foreground">{t("subtitle")}</p>
          </div>
          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
            <DialogTrigger asChild>
              <Button className="bg-gradient-primary text-primary-foreground hover:opacity-90">
                <Plus className="w-4 h-4 mr-2" />
                {t("addOffer")}
              </Button>
            </DialogTrigger>
            <DialogContent className="sm:max-w-[600px]">
              <DialogHeader>
                <DialogTitle>
                  {/* //modifier */}
                {t(editingOffer ? "editOffer" : "addOffer")}
                </DialogTitle>
                <DialogDescription>
                  {/* modifier */}
                  {t(editingOffer ? "editDesc" : "addDesc")}
                </DialogDescription>
              </DialogHeader>
              <div className="grid gap-4 py-4 max-h-[60vh] overflow-y-auto">
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="title" className="text-right">
                    {/* modifier */}
                    {t("title")} *
                  </Label>
                  <Input
                    id="title"
                    value={newOffer.title}
                    onChange={(e) => setNewOffer((prev) => ({ ...prev, title: e.target.value }))}
                    className="col-span-3"
                    placeholder="Pack Site Web Premium"
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="description" className="text-right">
                    {/* modifier */}
                    {t("description")}
                  </Label>
                  <Textarea
                    id="description"
                    value={newOffer.description}
                    onChange={(e) => setNewOffer((prev) => ({ ...prev, description: e.target.value }))}
                    className="col-span-3"
                    placeholder={t("descriptionPlaceholder")}
                    rows={3}
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="price" className="text-right">
                    {t("price")} *
                  </Label>
                  <div className="col-span-3 flex gap-2">
                    <Input
                      id="price"
                      type="number"
                      step="0.01"
                      min={0}
                      inputMode="decimal"
                      value={newOffer.price ?? ""}
                      onChange={(e) => {
                        const value = e.target.value;
                        const numeric = parseFloat(value);
                        setNewOffer((prev) => ({
                          ...prev,
                          price: value === "" || isNaN(numeric) ? 0 : Math.max(0, numeric),
                        }));
                      }}
                      className="flex-1"
                      placeholder="299"
                    />
                    <Select
                      value={newOffer.currency}
                      onValueChange={(value) => setNewOffer((prev) => ({ ...prev, currency: value }))}
                    >
                      <SelectTrigger className="w-24">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="EUR">EUR</SelectItem>
                        <SelectItem value="USD">USD</SelectItem>
                        <SelectItem value="GBP">GBP</SelectItem>
                        <SelectItem value="CAD">CAD</SelectItem>
                        <SelectItem value="MGA">MGA</SelectItem>
                        <SelectItem value="XOF">XOF</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="category" className="text-right">
                    {/* modifier */}
                    {t("category", { ns: "common" })} *
                  </Label>
                  <Select
                    value={isCustomCategory ? "custom" : newOffer.category}
                    onValueChange={(value) => {
                      if (value === "custom") {
                        setIsCustomCategory(true);
                        setCustomCategory("");
                        setNewOffer((prev) => ({ ...prev, category: "" }));
                      } else {
                        setIsCustomCategory(false);
                        setCustomCategory("");
                        setNewOffer((prev) => ({ ...prev, category: value }));
                      }
                    }}
                  >
                    <SelectTrigger className="col-span-3">
                    <SelectValue 
                      placeholder={t("category", { ns: "common" })}
                    >
                      {newOffer.category && !isCustomCategory ? getCategoryLabel(newOffer.category) : null}
                    </SelectValue>
                    </SelectTrigger>
                    <SelectContent>
                    {/* CatÃ©gories principales */}
                    <SelectItem value="web">ğŸŒ DÃ©veloppement Web</SelectItem>
                    <SelectItem value="seo">ğŸ” SEO & RÃ©fÃ©rencement</SelectItem>
                    <SelectItem value="marketing">ğŸ“ˆ Marketing Digital</SelectItem>
                    <SelectItem value="design">ğŸ¨ Design & Graphisme</SelectItem>
                    <SelectItem value="consulting">ğŸ’¡ Consulting & Conseil</SelectItem>
                    
                    {/* CatÃ©gories supplÃ©mentaires synchronisÃ©es avec marketplace */}
                    <SelectItem value="courses">ğŸ“ Formations & Cours</SelectItem>
                    <SelectItem value="software">âš¡ Logiciels & Outils</SelectItem>
                    <SelectItem value="digital_products">ğŸ’» Produits NumÃ©riques</SelectItem>
                    <SelectItem value="services">ğŸ› ï¸ Services Divers</SelectItem>
                    <SelectItem value="electronics">ğŸ“± Ã‰lectronique</SelectItem>
                    <SelectItem value="fashion">ğŸ‘— Mode & Style</SelectItem>
                    <SelectItem value="home">ğŸ  Maison & Jardin</SelectItem>
                    <SelectItem value="automotive">ğŸš— Automobile</SelectItem>
                    <SelectItem value="sports">âš½ Sports & Loisirs</SelectItem>
                    <SelectItem value="health">ğŸ’Š SantÃ© & Bien-Ãªtre</SelectItem>
                    <SelectItem value="books">ğŸ“š Livres & Ã‰ducation</SelectItem>
                    <SelectItem value="arts">ğŸ­ Arts & Culture</SelectItem>
                    <SelectItem value="business">ğŸ’¼ Business & Finance</SelectItem>
                    <SelectItem value="travel">âœˆï¸ Voyage & Tourisme</SelectItem>
                    <SelectItem value="food">ğŸ½ï¸ Alimentation</SelectItem>
                    
                    <SelectItem value="custom">+ Autre</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                {/* Champ pour catÃ©gorie personnalisÃ©e */}
                {isCustomCategory && (
                  <div className="grid grid-cols-4 items-center gap-4">
                    <Label htmlFor="customCategory" className="text-right">
                      CatÃ©gorie personnalisÃ©e *
                    </Label>
                    <Input
                      id="customCategory"
                      value={customCategory}
                      onChange={(e) => {
                        setCustomCategory(e.target.value);
                        setNewOffer((prev) => ({ ...prev, category: e.target.value }));
                      }}
                      className="col-span-3"
                      placeholder="Entrez votre catÃ©gorie..."
                    />
                  </div>
                )}
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="validUntil" className="text-right">
                    {t("validUntil")}
                  </Label>
                  <Input
                    id="validUntil"
                    type="date"
                    value={newOffer.validUntil}
                    onChange={(e) => setNewOffer((prev) => ({ ...prev, validUntil: e.target.value }))}
                    className="col-span-3"
                  />
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="delivery_date" className="text-right">
                    Date de livraison
                  </Label>
                  <Input
                    id="delivery_date"
                    type="date"
                    value={newOffer.delivery_date}
                    onChange={(e) => setNewOffer((prev) => ({ ...prev, delivery_date: e.target.value }))}
                    className="col-span-3"
                  />
                </div>
                {/* ici le champp pour la localisation de la disponibilitÃ© */}
                
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="localisation" className="text-right">
                    DisponibilitÃ© <span className="text-red-500">*</span>
                  </Label>

                  <Select
                    value={newOffer.localisation || ""}
                    onValueChange={(value) => {console.log("ğŸ¯ SELECT CHANGED:", value);
                      setNewOffer(prev => ({ ...prev, localisation: value }))}}
                  >
                    <SelectTrigger className="col-span-3">
                      <SelectValue placeholder="SÃ©lectionnez le pays de disponibilitÃ©" />
                      {/* Cette ligne fait apparaÃ®tre la flÃ¨che â†“ exactement comme sur tes filtres */}
                      <ChevronsUpDown className="h-4 w-4 opacity-50 shrink-0 ml-auto" />
                    </SelectTrigger>

                    <SelectContent 
                      position="popper"
                      sideOffset={8}
                      className="z-[9999] w-[var(--radix-select-trigger-width)] max-h-96"
                    >
                      {[
                        "Madagascar", "France", "Canada", "Belgique", "Suisse", "RÃ©union", "Maurice", "Ã‰tats-Unis",
                        "Allemagne", "Espagne", "Italie", "Portugal", "Maroc", "Tunisie", "SÃ©nÃ©gal", "CÃ´te d'Ivoire"
                      ].concat([
                        "Afghanistan","Afrique du Sud","Albanie","AlgÃ©rie","Andorre","Angola","Antigua-et-Barbuda",
                        "Arabie Saoudite","Argentine","ArmÃ©nie","Australie","Autriche","AzerbaÃ¯djan","Bahamas",
                        "BahreÃ¯n","Bangladesh","Barbade","BiÃ©lorussie","Belize","BÃ©nin","Bhoutan","Bolivie",
                        "Bosnie-HerzÃ©govine","Botswana","BrÃ©sil","Brunei","Bulgarie","Burkina Faso","Burundi",
                        "Cambodge","Cameroun","Cap-Vert","Chili","Chine","Chypre","Colombie","Comores",
                        "Congo (Brazzaville)","Congo (Kinshasa)","CorÃ©e du Nord","CorÃ©e du Sud","Costa Rica",
                        "Croatie","Cuba","Danemark","Djibouti","Dominique","Ã‰gypte","Ã‰mirats Arabes Unis",
                        "Ã‰quateur","Ã‰rythrÃ©e","Estonie","Eswatini","Ã‰thiopie","Fidji","Finlande","Gabon","Gambie",
                        "GÃ©orgie","Ghana","GrÃ¨ce","Grenade","Guatemala","GuinÃ©e","GuinÃ©e-Bissau","GuinÃ©e Ã‰quatoriale",
                        "Guyana","HaÃ¯ti","Honduras","Hongrie","Inde","IndonÃ©sie","Iran","Iraq","Irlande","Islande",
                        "IsraÃ«l","JamaÃ¯que","Japon","Jordanie","Kazakhstan","Kenya","Kirghizistan","Kiribati",
                        "KoweÃ¯t","Laos","Lesotho","Lettonie","Liban","Liberia","Libye","Liechtenstein","Lituanie",
                        "Luxembourg","MacÃ©doine du Nord","Malaisie","Malawi","Maldives","Mali","Malte","Maroc",
                        "Mauritanie","Mexique","MicronÃ©sie","Moldavie","Monaco","Mongolie","MontÃ©nÃ©gro","Mozambique",
                        "Myanmar","Namibie","Nauru","NÃ©pal","Nicaragua","Niger","Nigeria","NorvÃ¨ge","Nouvelle-ZÃ©lande",
                        "Oman","Ouganda","OuzbÃ©kistan","Pakistan","Palaos","Palestine","Panama","Papouasie-Nouvelle-GuinÃ©e",
                        "Paraguay","Pays-Bas","PÃ©rou","Philippines","Pologne","Qatar","RÃ©publique Centrafricaine",
                        "RÃ©publique Dominicaine","RÃ©publique TchÃ¨que","Roumanie","Royaume-Uni","Russie","Rwanda",
                        "Saint-Kitts-et-Nevis","Saint-Vincent-et-les-Grenadines","Sainte-Lucie","Salomon","Salvador",
                        "Samoa","SÃ£o TomÃ©-et-Principe","SÃ©nÃ©gal","Serbie","Seychelles","Sierra Leone","Singapour",
                        "Slovaquie","SlovÃ©nie","Somalie","Soudan","Soudan du Sud","Sri Lanka","SuÃ¨de","Suriname",
                        "Syrie","Tadjikistan","Tanzanie","Tchad","ThaÃ¯lande","Timor-Oriental","Togo","Tonga",
                        "TrinitÃ©-et-Tobago","Tunisie","TurkmÃ©nistan","Turquie","Tuvalu","Ukraine","Uruguay","Vanuatu",
                        "Vatican","Venezuela","Vietnam","YÃ©men","Zambie","Zimbabwe"
                      ].sort((a, b) => a.localeCompare(b)))
                      .map(pays => (
                        <SelectItem key={pays} value={pays}>
                          {pays === "Madagascar" && "ğŸ‡²ğŸ‡¬ "}
                          {pays === "France" && "ğŸ‡«ğŸ‡· "}
                          {pays === "Canada" && "ğŸ‡¨ğŸ‡¦ "}
                          {pays === "Ã‰tats-Unis" && "ğŸ‡ºğŸ‡¸ "}
                          {pays}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
                              
                <div className="grid grid-cols-4 items-start gap-4">
                  <Label className="text-right pt-2">
                    Images
                  </Label>
                  <div className="col-span-3">
                    <MultipleImageUpload
                      value={newOffer.images}
                      onChange={(urls) => setNewOffer((prev) => ({ 
                        ...prev, 
                        images: urls,
                        avatar: urls[0] || "" // La premiÃ¨re image devient l'avatar
                      }))}
                      maxImages={5}
                    />
                  </div>
                </div>
                <div className="grid grid-cols-4 items-center gap-4">
                  <Label htmlFor="condition_state" className="text-right">
                    Ã‰tat
                  </Label>
                  <Select
                    value={newOffer.condition_state}
                    onValueChange={(value) => setNewOffer((prev) => ({ ...prev, condition_state: value as any }))}
                  >
                    <SelectTrigger className="col-span-3">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="new">Neuf</SelectItem>
                      <SelectItem value="like_new">Comme neuf</SelectItem>
                      <SelectItem value="good">Bon Ã©tat</SelectItem>
                      <SelectItem value="fair">Ã‰tat correct</SelectItem>
                      <SelectItem value="poor">Mauvais Ã©tat</SelectItem>
                      <SelectItem value="to_repair">Ã€ rÃ©parer</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="grid grid-cols-4 items-start gap-4">
                  <Label className="text-right pt-2">
                    Tags
                  </Label>
                  <div className="col-span-3 space-y-3">
                    {/* Tags existants */}
                    {newOffer.tags && newOffer.tags.length > 0 && (
                      <div className="flex flex-wrap gap-2 p-2 border rounded-md bg-muted/20">
                        {newOffer.tags.map((tag, index) => (
                          <Badge
                            key={index}
                            variant="secondary"
                            className="flex items-center gap-1 px-2 py-1 text-sm"
                          >
                            {tag}
                            <button
                              type="button"
                              onClick={() => {
                                const updatedTags = newOffer.tags?.filter((_, i) => i !== index) || [];
                                setNewOffer((prev) => ({ ...prev, tags: updatedTags }));
                              }}
                              className="ml-1 hover:bg-destructive/20 rounded-full p-0.5 transition-colors"
                            >
                              <X className="h-3 w-3" />
                            </button>
                          </Badge>
                        ))}
                      </div>
                    )}
                    
                    {/* Input pour ajouter des tags */}
                    <div className="space-y-2">
                      <div className="flex gap-2">
                        <Input
                          id="newTag"
                          value={newTagInput}
                          onChange={(e) => setNewTagInput(e.target.value)}
                          placeholder="Tapez votre propre tag (ex: blockchain, ia, mobile...)"
                          onKeyDown={(e) => {
                            console.log('ğŸ¹ Touche pressÃ©e:', e.key);
                            if (e.key === 'Enter') {
                              e.preventDefault();
                              console.log('ğŸ¯ EntrÃ©e dÃ©tectÃ©e, valeur input:', newTagInput);
                              addTag(newTagInput);
                            }
                          }}
                          className="flex-1"
                        />
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            console.log('ğŸ–±ï¸ Clic bouton +, valeur input:', newTagInput);
                            addTag(newTagInput);
                          }}
                          disabled={(newOffer.tags?.length || 0) >= 10}
                        >
                          <Plus className="h-4 w-4" />
                        </Button>
                      </div>
                      <p className="text-xs text-muted-foreground">
                        ğŸ’¡ Vous pouvez crÃ©er vos propres tags personnalisÃ©s ou utiliser les suggestions ci-dessous
                      </p>
                      
                    </div>
                    
                    {/* Tags suggÃ©rÃ©s */}
                    <div className="space-y-2">
                      <p className="text-sm text-muted-foreground">Tags populaires :</p>
                      <div className="flex flex-wrap gap-1">
                        {suggestedTags.map((suggestion) => {
                          const isAlreadyAdded = newOffer.tags?.includes(suggestion);
                          const isLimitReached = (newOffer.tags?.length || 0) >= 10;
                          const isDisabled = isAlreadyAdded || isLimitReached;
                          
                          return (
                            <Badge
                              key={suggestion}
                              variant={isAlreadyAdded ? "default" : "outline"}
                              className={`text-xs transition-colors ${
                                isDisabled 
                                  ? 'opacity-50 cursor-not-allowed' 
                                  : 'cursor-pointer hover:bg-primary/10'
                              }`}
                              onClick={() => {
                                if (!isDisabled) {
                                  console.log('ğŸ·ï¸ Clic sur suggestion:', suggestion);
                                  addTag(suggestion);
                                }
                              }}
                            >
                              {suggestion}
                              {isAlreadyAdded && <span className="ml-1">âœ“</span>}
                            </Badge>
                          );
                        })}
                      </div>
                    </div>
                    
                    <div className="flex items-center justify-between text-xs text-muted-foreground">
                      <span>
                        {newOffer.tags?.length || 0}/10 tags â€¢ Appuyez sur EntrÃ©e ou cliquez sur +
                      </span>
                      {(newOffer.tags?.length || 0) >= 10 && (
                        <span className="text-orange-500 font-medium">
                          Limite atteinte
                        </span>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              <DialogFooter>
                <Button variant="outline" onClick={() => {
                  setIsDialogOpen(false);
                  setEditingOffer(null);
                  setNewOffer({ 
                    title: "", 
                    description: "", 
                    price: 0, 
                    currency: "EUR",
                    category: "", 
                    validUntil: "",
                    delivery_date: "",
                    localisation: "",
                    avatar: "",
                    images: [], // Reset des images
                    condition_state: "new",
                    tags: [],
                    reviews: [],
                    created_at: undefined,
                    updated_at: undefined,
                  });
                  setIsCustomCategory(false);
                  setCustomCategory("");
                }}>
                  {t("cancel")}
                </Button>
                <Button onClick={handleCreateOrUpdateOffer}>
                  {t(editingOffer ? "saveChanges" : "create")}
                </Button>
              </DialogFooter>
            </DialogContent>
          </Dialog>
        </div>

        {/* âœ… Filters gardÃ©s */}
        <Card>
          <CardContent className="p-4">
            <div className="flex flex-col sm:flex-row gap-4">
              <div className="relative flex-1">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4" />
                <Input
                  type="text"
                  placeholder={t("search")}
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10"
                />
              </div>
              <Select value={selectedCategory} onValueChange={setSelectedCategory}>
                <SelectTrigger className="w-full sm:w-48">
                  <Filter className="w-4 h-4 mr-2" />
                  <SelectValue placeholder={t("category", { ns: "common" })} />
                </SelectTrigger>
                <SelectContent>
                <SelectItem value="all">Toutes les catÃ©gories</SelectItem>
                {/* CatÃ©gories principales */}
                <SelectItem value="web">ğŸŒ DÃ©veloppement Web</SelectItem>
                <SelectItem value="seo">ğŸ” SEO & RÃ©fÃ©rencement</SelectItem>
                <SelectItem value="marketing">ğŸ“ˆ Marketing Digital</SelectItem>
                <SelectItem value="design">ğŸ¨ Design & Graphisme</SelectItem>
                <SelectItem value="consulting">ğŸ’¡ Consulting & Conseil</SelectItem>
                
                {/* CatÃ©gories supplÃ©mentaires */}
                <SelectItem value="courses">ğŸ“ Formations & Cours</SelectItem>
                <SelectItem value="software">âš¡ Logiciels & Outils</SelectItem>
                <SelectItem value="digital_products">ğŸ’» Produits NumÃ©riques</SelectItem>
                <SelectItem value="services">ğŸ› ï¸ Services Divers</SelectItem>
                <SelectItem value="electronics">ğŸ“± Ã‰lectronique</SelectItem>
                <SelectItem value="fashion">ğŸ‘— Mode & Style</SelectItem>
                <SelectItem value="home">ğŸ  Maison & Jardin</SelectItem>
                <SelectItem value="automotive">ğŸš— Automobile</SelectItem>
                <SelectItem value="sports">âš½ Sports & Loisirs</SelectItem>
                <SelectItem value="health">ğŸ’Š SantÃ© & Bien-Ãªtre</SelectItem>
                </SelectContent>
              </Select>
              <Select value={selectedStatus} onValueChange={setSelectedStatus}>
                <SelectTrigger className="w-full sm:w-48">
                  <SelectValue placeholder={t("status")} />
                </SelectTrigger>
                <SelectContent>
                <SelectItem value="all">{t("allStatuses")}</SelectItem>
                <SelectItem value="active">{t("active")}</SelectItem>
                <SelectItem value="pending">{t("pending")}</SelectItem>
                </SelectContent>
              </Select>
            </div>
            
            {/* Compteur de rÃ©sultats */}
            <div className="flex items-center justify-between mt-4 pt-4 border-t">
              <div className="text-sm text-muted-foreground">
                {searchTerm.trim() || selectedCategory !== "all" || selectedStatus !== "all"
                  ? `${filteredOffers.length} offre(s) trouvÃ©e(s)` 
                  : `${offers.length} offres au total`
                }
              </div>
              {(selectedCategory !== "all" || selectedStatus !== "all" || searchTerm.trim()) && (
                <div className="flex items-center gap-2">
                  {selectedCategory !== "all" && (
                    <Badge variant="secondary" className="text-xs">
                      {getCategoryLabel(selectedCategory)}
                    </Badge>
                  )}
                  {selectedStatus !== "all" && (
                    <Badge variant="outline" className="text-xs">
                      {selectedStatus === "active" ? "Actives" : selectedStatus === "pending" ? "En attente" : selectedStatus}
                    </Badge>
                  )}
                  <Button 
                    variant="ghost" 
                    size="sm" 
                    className="text-xs h-6 px-2"
                    onClick={() => {
                      setSearchTerm("");
                      setSelectedCategory("all");
                      setSelectedStatus("all");
                    }}
                  >
                    RÃ©initialiser
                  </Button>
                </div>
              )}
            </div>
          </CardContent>
        </Card>

        {/* âœ… Offers Grid gardÃ©e */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredOffers.map((offer) => (
            <Card key={offer.id} className="hover:shadow-md transition-shadow">
              <CardHeader>
                <div className="flex items-start justify-between">
                  <div className="space-y-1">
                    <CardTitle className="text-lg">{offer.title}</CardTitle>
                    <p className="text-sm text-muted-foreground">{offer.description}</p>
                  </div>
                  {getStatusBadge(offer.status, t)}
                </div>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-2xl font-bold text-primary">{offer.price}â‚¬</span>
                  <Badge variant="outline" className="text-xs">
                  {offer.clientsCount} {t(offer.clientsCount > 1 ? "soldPlural" : "soldSingular")}
                  </Badge>
                </div>
                <div className="space-y-2">
                  <div className="flex items-center gap-2">
                    <Badge variant="secondary" className="text-xs">
                      {getCategoryLabel(offer.category)}
                    </Badge>
                  </div>
                  {/* Affichage des tags */}
                  {offer.tags && offer.tags.length > 0 && (
                    <div className="flex flex-wrap gap-1">
                      {offer.tags.slice(0, 3).map((tag, index) => (
                        <Badge key={index} variant="outline" className="text-xs">
                          {tag}
                        </Badge>
                      ))}
                      {offer.tags.length > 3 && (
                        <Badge variant="outline" className="text-xs">
                          +{offer.tags.length - 3}
                        </Badge>
                      )}
                    </div>
                  )}
                </div>
                {offer.validUntil && (
                  <div className="text-xs text-muted-foreground">
                    {t("validUntil")} {new Date(offer.validUntil).toLocaleDateString("fr-FR")}
                  </div>
                )}
                {/* Boutons actions */}
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    size="sm"
                    className="flex-1"
                    onClick={() => handleEditOffer(offer)}
                  >
                    <Edit className="w-4 h-4 mr-1" />
                    {t("edit")}
                  </Button>
                  <Button
                    variant="destructive"
                    size="sm"
                    className="flex-1"
                    onClick={() => setOfferToDelete(offer)}>
                    {t("delete")}
                  </Button>
                </div>
                {/* âœ… Bouton vendre sur une ligne Ã  part */}
                <Button
                  size="sm"
                  className="w-full mt-2"
                  onClick={() => setSellingOffer(offer)}
                  //onClick={() => handleSellOffer(offer.id, offer.title)}
                >
                  <ShoppingCart className="w-4 h-4 mr-1" />
                  {t("sell")}
                </Button>

                <Link to={`/agency/offres/${offer.id}`} className="block mt-3">
                  <Button variant="secondary" size="sm" className="w-full">
                    {t("profileDetails")}
                  </Button>
                </Link>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* âœ… Stats dynamiques */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center space-x-2">
                <div className="p-2 bg-primary/10 rounded-lg">
                  <ShoppingCart className="w-5 h-5 text-primary" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">{t("activeOffers")}</p>
                  <p className="text-2xl font-bold">{activeOffersCount}</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center space-x-2">
                <div className="p-2 bg-success/10 rounded-lg">
                  <CheckCircle className="w-5 h-5 text-success" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">{t("totalSales")}</p>
                  <p className="text-2xl font-bold">{totalSales}</p>
                </div>
              </div>
            </CardContent>
          </Card>
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center space-x-2">
                <div className="p-2 bg-warning/10 rounded-lg">
                  <Clock className="w-5 h-5 text-warning" />
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">{t("totalRevenue")}</p>
                  <p className="text-2xl font-bold">{totalRevenue.toLocaleString('fr-FR')}â‚¬</p>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* âœ… Confirmation suppression */}
      <Dialog open={!!offerToDelete} onOpenChange={() => setOfferToDelete(null)}>
        <DialogContent className="sm:max-w-[400px]">
          <DialogHeader>
            <DialogTitle>{t("confirmDelete")}</DialogTitle>
            <DialogDescription>
              {t("confirmDeleteDesc", { title: offerToDelete?.title })}
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button variant="outline" onClick={() => setOfferToDelete(null)}>
              {t("cancel")}
            </Button>
            <Button
              variant="destructive"
              onClick={() => {
                fetch(`${API_URL}/${offerToDelete?.id}`, { method: "DELETE" })
                  .then(() => {
                    setOffers(prev => prev.filter(o => o.id !== offerToDelete?.id));
                    toast({
                      title: "Offre supprimÃ©e",
                      description: `L'offre "${offerToDelete?.title}" a Ã©tÃ© retirÃ©e.`
                    });
                    setOfferToDelete(null);
                  })
                  .catch(err => {
                    toast({
                      title: "Erreur",
                      description: "Impossible de supprimer l'offre.",
                      variant: "destructive"
                    });
                    console.error(err);
                  });
              }}
            >
              {t("delete")}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </AgencyLayout>
{/* MODAL DE VENTE SIMPLIFIÃ‰ */}
<Dialog open={!!sellingOffer} onOpenChange={() => setSellingOffer(null)}>
  <DialogContent className="sm:max-w-[500px]">
    <DialogHeader>
      <DialogTitle>{t("offers.sell")} {sellingOffer?.title}</DialogTitle>
      <DialogDescription>
        {t("selectClient")}
      </DialogDescription>
    </DialogHeader>
    <div className="space-y-4">
      {/* BARRE DE RECHERCHE */}
        <Input 
          placeholder={t("common.search")} 
          value={searchClient}
          onChange={(e) => setSearchClient(e.target.value)}
        />
        <div className="border rounded-lg p-2 h-40 overflow-y-auto">
          {/* UTILISE filteredClients AU LIEU DE clients */}
          {filteredClients.map(client => (
            <div 
              key={client.id} 
              className="p-2 hover:bg-gray-100 rounded cursor-pointer"
              onClick={() => {
                fetch(`http://127.0.0.1:8000/api/offers/${sellingOffer!.id}/attach-client/${client.id}`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                      "Authorization": `Bearer ${localStorage.getItem('token')}`
                    }
                  })
                  .then(() => {
                    setOffers(prev => prev.map(o => 
                      o.id === sellingOffer!.id 
                        ? {...o, clientsCount: o.clientsCount + 1}
                        : o
                    ));
                  })
                toast({ 
                  title: "Vente enregistrÃ©e", 
                  description: `${client.name} a achetÃ© "${sellingOffer!.title}"` 
                });
                setSellingOffer(null);
              }}
            >
              {client.name} - {client.company}
            </div>
          ))}
        </div>
      </div>
    </DialogContent>
  </Dialog>
  </>
      
  ); 
}